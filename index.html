<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>FX Commission Calculator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
      font-family: -apple-system, system-ui, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
    }
    body {
      margin: 0;
      padding: 16px;
      background: #050816;
      color: #f5f5f5;
    }
    h1 {
      font-size: 1.4rem;
      margin: 0 0 4px;
    }
    .subtitle {
      font-size: 0.8rem;
      color: #9ca3af;
      margin-bottom: 12px;
    }
    .card {
      background: #0b1020;
      border-radius: 12px;
      padding: 14px;
      margin-bottom: 12px;
      border: 1px solid #1f2937;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.6);
    }
    label {
      display: block;
      font-size: 0.8rem;
      margin-bottom: 4px;
      color: #c7d2fe;
    }
    input, select {
      width: 100%;
      padding: 8px 10px;
      margin-bottom: 10px;
      border-radius: 8px;
      border: 1px solid #374151;
      background: #050816;
      color: #f9fafb;
      font-size: 0.9rem;
      outline: none;
    }
    input:focus, select:focus {
      border-color: #4f46e5;
      box-shadow: 0 0 0 1px rgba(79, 70, 229, 0.5);
    }
    button {
      width: 100%;
      padding: 10px;
      border-radius: 999px;
      border: none;
      font-size: 0.95rem;
      font-weight: 600;
      background: linear-gradient(135deg, #4f46e5, #06b6d4);
      color: #ffffff;
      cursor: pointer;
      margin: 4px 0 10px;
    }
    button:active {
      transform: scale(0.98);
    }
    .row {
      display: flex;
      gap: 8px;
    }
    .row > div {
      flex: 1;
    }
    .result {
      font-size: 0.9rem;
      line-height: 1.4;
      white-space: pre-line;
    }
    .small {
      font-size: 0.75rem;
      color: #9ca3af;
    }
    .warning {
      font-size: 0.75rem;
      color: #fbbf24;
      margin-top: 4px;
    }
    .tag {
      display: inline-block;
      font-size: 0.7rem;
      padding: 2px 6px;
      border-radius: 999px;
      background: #111827;
      border: 1px solid #374151;
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <h1>FX Commission Calculator</h1>
  <div class="subtitle">
    Cuenta <strong>RAW Pricing</strong> de Forex.com – 7 unidades de la moneda
    base por lote y por lado. Costo mostrado = <strong>round-trip (in + out) por trade</strong>.
  </div>

  <div class="card">
    <label for="pair">Par (ej: EURUSD, GU, UJ, GJ…)</label>
    <input id="pair" type="text" placeholder="EURUSD / GU / UJ / GJ" />

    <div class="row">
      <div>
        <label for="direction">Dirección</label>
        <select id="direction">
          <option value="BUY">BUY</option>
          <option value="SELL">SELL</option>
        </select>
      </div>
      <div>
        <label for="price">Precio actual (deja vacío para auto)</label>
        <input id="price" type="number" step="0.00001" placeholder="auto" />
      </div>
    </div>

    <label for="lot">Tamaño de lote (ej: 0.5, 1, 8)</label>
    <input id="lot" type="number" step="0.01" placeholder="1" />

    <div class="small">
      Auto-pair soporta:
      <span class="tag">EU → EURUSD</span>
      <span class="tag">GU → GBPUSD</span>
      <span class="tag">UJ → USDJPY</span>
      <span class="tag">EJ → EURJPY</span>
      <span class="tag">GJ → GBPJPY</span>
      <span class="tag">AU → AUDUSD</span>
      <span class="tag">NU → NZDUSD</span>
      <span class="tag">UC → USDCAD</span>
    </div>

    <div id="pairWarning" class="warning" style="display: none">
      No se pudo obtener correctamente la conversión base→USD. Ajusta el resultado manualmente si operas cruces raros.
    </div>
    <div id="apiWarning" class="warning" style="display: none">
      No se pudo obtener el precio en vivo. Pon el precio manualmente.
    </div>
  </div>

  <div class="card">
    <label for="tradesDay">Trades totales por día (opcional)</label>
    <input id="tradesDay" type="number" step="1" placeholder="20" />

    <label for="tokyo">Trades sesión Tokyo (opcional)</label>
    <input id="tokyo" type="number" step="1" placeholder="5" />

    <label for="london">Trades sesión London (opcional)</label>
    <input id="london" type="number" step="1" placeholder="10" />

    <label for="ny">Trades sesión New York (opcional)</label>
    <input id="ny" type="number" step="1" placeholder="3" />

    <div class="small">
      Si solo pones trades/día → calcula coste diario.
      <br />
      Si también pones Tokyo/London/NY → coste por sesión.
    </div>
  </div>

  <button id="calcBtn">CALCULAR</button>

  <div class="card">
    <div id="result" class="result">
      Rellena los campos y pulsa CALCULAR.
    </div>
  </div>

  <script>
    // Alias tipo GU, EU, UJ, etc.
    function normalizePairInput(raw) {
      if (!raw) return null;
      let s = raw.trim().toUpperCase();
      s = s.replace(/[^A-Z]/g, "");

      const aliasMap = {
        EU: "EURUSD",
        GU: "GBPUSD",
        UJ: "USDJPY",
        EJ: "EURJPY",
        GJ: "GBPJPY",
        AU: "AUDUSD",
        NU: "NZDUSD",
        UC: "USDCAD"
      };

      if (aliasMap[s]) return aliasMap[s];
      if (s.length === 6) return s;
      return null;
    }

    function parsePair(raw) {
      const norm = normalizePairInput(raw);
      if (!norm) return null;
      const base = norm.slice(0, 3);
      const quote = norm.slice(3, 6);
      return { full: norm, base, quote };
    }

    // Precio spot base→quote
    async function fetchLivePrice(base, quote) {
      const url = `https://api.exchangerate.host/latest?base=${base}&symbols=${quote}`;
      const resp = await fetch(url);
      if (!resp.ok) throw new Error("Bad response");
      const data = await resp.json();
      if (!data.rates || !data.rates[quote]) throw new Error("No rate");
      return data.rates[quote]; // 1 base = rate quote
    }

    // 1 USD = r BASE → 1 BASE = 1/r USD
    async function fetchBaseToUsd(base) {
      if (base === "USD") return 1.0;
      const url = `https://api.exchangerate.host/latest?base=USD&symbols=${base}`;
      const resp = await fetch(url);
      if (!resp.ok) throw new Error("Bad response");
      const data = await resp.json();
      if (!data.rates || !data.rates[base]) throw new Error("No rate");
      const r = data.rates[base]; // 1 USD = r BASE
      return 1.0 / r;             // 1 BASE = 1/r USD
    }

    async function calc() {
      const pairInput = document.getElementById("pair").value;
      const direction = document.getElementById("direction").value;
      let priceInput = parseFloat(document.getElementById("price").value);
      const lotInput = parseFloat(document.getElementById("lot").value);
      const tradesDay = parseFloat(document.getElementById("tradesDay").value);
      const tradesTokyo = parseFloat(document.getElementById("tokyo").value);
      const tradesLondon = parseFloat(document.getElementById("london").value);
      const tradesNY = parseFloat(document.getElementById("ny").value);

      const resultDiv = document.getElementById("result");
      const pairWarning = document.getElementById("pairWarning");
      const apiWarning = document.getElementById("apiWarning");
      pairWarning.style.display = "none";
      apiWarning.style.display = "none";

      const pair = parsePair(pairInput);
      if (!pair) {
        resultDiv.textContent =
          "Par inválido. Usa algo tipo EURUSD, GU, UJ, GJ…";
        return;
      }

      // Si no hay precio -> pedirlo (par de trading)
      if (!priceInput || priceInput <= 0) {
        try {
          const live = await fetchLivePrice(pair.base, pair.quote);
          priceInput = live;
          document.getElementById("price").value = live.toFixed(5);
        } catch (e) {
          apiWarning.style.display = "block";
          resultDiv.textContent =
            "No se pudo obtener el precio en vivo. Escribe el precio manualmente.";
          return;
        }
      }

      if (!lotInput || lotInput <= 0) {
        resultDiv.textContent = "Pon un tamaño de lote mayor que 0.";
        return;
      }

      const BASE = 7.0; // 7 unidades de la moneda base por lado/lote
      let baseToUsd = 1.0;

      try {
        if (pair.base === "USD") {
          baseToUsd = 1.0; // 7 USD por lado
        } else if (pair.quote === "USD") {
          // XXXUSD → el precio ya es base→USD
          baseToUsd = priceInput;
        } else {
          // cruces sin USD → usar 1 USD = r BASE → 1 BASE = 1/r USD
          baseToUsd = await fetchBaseToUsd(pair.base);
        }
      } catch (e) {
        baseToUsd = 1.0;
        pairWarning.style.display = "block";
      }

      const perSidePerLot = BASE * baseToUsd;
      const roundTripPerLot = perSidePerLot * 2;
      const perTrade = roundTripPerLot * lotInput;

      let lines = [];
      lines.push(`Par: ${pair.full}`);
      lines.push(`Dirección: ${direction}`);
      lines.push(`Precio usado: ${priceInput}`);
      lines.push(`Lotes: ${lotInput}`);
      lines.push("");
      lines.push("Por lote (1.0 lot):");
      lines.push(`• Comisión por lado: $${perSidePerLot.toFixed(2)}`);
      lines.push(
        `• Comisión round-trip (in + out): $${roundTripPerLot.toFixed(2)}`
      );
      lines.push("");
      lines.push(`Por trade con ${lotInput} lot(es):`);
      lines.push(`• Comisión total (in + out): $${perTrade.toFixed(2)}`);

      if (!isNaN(tradesDay) && tradesDay > 0) {
        const daily = perTrade * tradesDay;
        lines.push("");
        lines.push(`Coste diario aprox (${tradesDay} trades/día):`);
        lines.push(`• $${daily.toFixed(2)} en comisiones`);
      }

      const haveSessions =
        (!isNaN(tradesTokyo) && tradesTokyo > 0) ||
        (!isNaN(tradesLondon) && tradesLondon > 0) ||
        (!isNaN(tradesNY) && tradesNY > 0);

      if (haveSessions) {
        lines.push("");
        lines.push("Coste por sesión:");
        if (!isNaN(tradesTokyo) && tradesTokyo > 0) {
          lines.push(
            `• Tokyo (${tradesTokyo} trades): $${(perTrade * tradesTokyo).toFixed(
              2
            )}`
          );
        }
        if (!isNaN(tradesLondon) && tradesLondon > 0) {
          lines.push(
            `• London (${tradesLondon} trades): $${(
              perTrade * tradesLondon
            ).toFixed(2)}`
          );
        }
        if (!isNaN(tradesNY) && tradesNY > 0) {
          lines.push(
            `• New York (${tradesNY} trades): $${(perTrade * tradesNY).toFixed(
              2
            )}`
          );
        }
      }

      resultDiv.textContent = lines.join("\n");
    }

    document.getElementById("calcBtn").addEventListener("click", () => {
      calc();
    });
  </script>
</body>
</html>